name: ðŸŽ¯ Lighthouse Testing
on:
  workflow_dispatch: true

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install Lighthouse
        run: npm install lighthouse puppeteer
          
      - name: Run Lighthouse tests
        run: |
          cat > lighthouse-test.js << 'EOF'
          const fs = require('fs');
          const lighthouse = require('lighthouse');
          const puppeteer = require('puppeteer');
          
          console.log('ðŸš€ Starting Lighthouse tests...');
          
          // Load YOUR data.json (with 'url' field)
          const data = JSON.parse(fs.readFileSync('data.json', 'utf8'));
          
          async function testAll() {
            const browser = await puppeteer.launch({
              args: ['--no-sandbox']
            });
            
            for (const student of data.approved || []) {
              // Use 'url' field (your format) OR 'site' field
              const url = student.url || student.site;
              
              if (!url || !url.startsWith('http')) {
                console.log(\`â­ï¸ Skipping \${student.name}: No valid URL\`);
                continue;
              }
              
              console.log(\`ðŸ” Testing \${student.name} - \${url}\`);
              
              try {
                // Run Lighthouse
                const result = await lighthouse(url, {
                  port: (new URL(browser.wsEndpoint())).port,
                  output: 'json',
                  onlyCategories: ['performance', 'accessibility', 'best-practices', 'seo']
                });
                
                const lhr = result.lhr;
                
                // UPDATE STUDENT DATA
                student.previousScore = student.score;
                
                // Performance score (0-100)
                student.score = Math.round(lhr.categories.performance.score * 100);
                
                // Other Lighthouse scores
                student.accessibility = Math.round(lhr.categories.accessibility.score * 100);
                student.bestPractices = Math.round(lhr.categories['best-practices'].score * 100);
                student.seo = Math.round(lhr.categories.seo.score * 100);
                
                // Core Web Vitals
                student.speedIndex = lhr.audits['speed-index']?.displayValue || 'N/A';
                student.firstContentfulPaint = lhr.audits['first-contentful-paint']?.displayValue || 'N/A';
                student.largestContentfulPaint = lhr.audits['largest-contentful-paint']?.displayValue || 'N/A';
                student.cumulativeLayoutShift = lhr.audits['cumulative-layout-shift']?.displayValue || 'N/A';
                student.totalBlockingTime = lhr.audits['total-blocking-time']?.displayValue || 'N/A';
                
                // Metadata
                student.lastTested = new Date().toISOString();
                student.testedWith = ['Lighthouse'];
                student.lighthouseVersion = lhr.lighthouseVersion;
                student.auditUrl = \`https://pagespeed.web.dev/analysis?url=\${encodeURIComponent(url)}\`;
                
                console.log(\`âœ… \${student.name}: Performance: \${student.score}/100 | A11y: \${student.accessibility}/100\`);
                
              } catch (error) {
                console.log(\`âŒ Failed \${student.name}: \${error.message}\`);
                student.lastTested = new Date().toISOString();
                student.testError = error.message;
              }
              
              // Be nice to student servers
              await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            await browser.close();
            
            // Save back to data.json
            data.lastUpdated = new Date().toISOString();
            data.testedWith = 'Lighthouse CI';
            
            fs.writeFileSync('data.json', JSON.stringify(data, null, 2));
            console.log(\`ðŸŽ‰ Updated \${data.approved?.length || 0} students!\`);
          }
          
          testAll().catch(console.error);
          EOF
          
          node lighthouse-test.js
          
      - name: Display results
        run: |
          echo "ðŸ“Š LIGHTHOUSE RESULTS:"
          node -e "
          const data = require('./data.json');
          console.log('');
          console.log('='.repeat(60));
          console.log('ðŸŽ¯ LIGHTHOUSE AUDIT RESULTS');
          console.log('='.repeat(60));
          
          data.approved?.forEach((s, i) => {
            const trend = s.previousScore ? 
              (s.score > s.previousScore ? 'ðŸ“ˆ +' + (s.score - s.previousScore) : 
               s.score < s.previousScore ? 'ðŸ“‰ ' + (s.score - s.previousScore) : 'âž¡ï¸ 0') : 'ðŸ†•';
            
            console.log(\`\${i+1}. \${s.name.padEnd(15)} \${s.score.toString().padStart(3)}/100 \${trend}\`);
            console.log(\`   Performance: \${s.score} | Accessibility: \${s.accessibility || 'N/A'} | SEO: \${s.seo || 'N/A'}\`);
            if (s.speedIndex !== 'N/A') {
              console.log(\`   Speed Index: \${s.speedIndex} | FCP: \${s.firstContentfulPaint}\`);
            }
            if (s.auditUrl) {
              console.log(\`   ðŸ”— \${s.auditUrl}\`);
            }
            console.log('');
          });
          "
          
      - name: Commit results
        run: |
          git config user.name "Lighthouse CI"
          git config user.email "lighthouse@github.com"
          git add data.json
          git commit -m "ðŸŽ¯ Lighthouse audit: $(date +'%Y-%m-%d')" || echo "No changes"
          git push
