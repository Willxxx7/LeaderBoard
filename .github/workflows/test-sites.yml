name: ğŸ¯ Lighthouse Testing
on:
  workflow_dispatch: true  # Manual trigger

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    
    steps:
      - name: âš¡ Checkout code (GETS data.json FROM YOUR REPO)
        uses: actions/checkout@v4
        
      - name: ğŸ› ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: ğŸ“¦ Install Lighthouse
        run: npm install lighthouse puppeteer
          
      - name: ğŸ¯ Load and test student sites
        run: |
          echo "ğŸ“‚ Loading data.json from repository..."
          
          # CREATE TEST SCRIPT
          cat > lighthouse-test.js << 'EOF'
          const fs = require('fs');
          const lighthouse = require('lighthouse');
          const puppeteer = require('puppeteer');
          
          console.log('ğŸš€ Starting Lighthouse testing...');
          
          // 1. LOAD YOUR EXISTING data.json
          const rawData = fs.readFileSync('data.json', 'utf8');
          const data = JSON.parse(rawData);
          
          console.log(\`ğŸ“Š Found \${data.approved?.length || 0} students to test\`);
          
          // 2. TEST EACH STUDENT'S SITE URL
          async function testAllSites() {
            const browser = await puppeteer.launch({
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            
            for (const student of data.approved || []) {
              const url = student.site;
              
              if (!url || !url.startsWith('http')) {
                console.log(\`â­ï¸  Skipping \${student.name}: Invalid URL\`);
                continue;
              }
              
              console.log(\`ğŸ” Testing \${student.name} - \${url}\`);
              
              try {
                // 3. RUN LIGHTHOUSE ON STUDENT'S SITE
                const result = await lighthouse(url, {
                  port: (new URL(browser.wsEndpoint())).port,
                  output: 'json',
                  onlyCategories: ['performance'],
                  throttlingMethod: 'simulate'
                });
                
                const perfScore = Math.round(result.lhr.categories.performance.score * 100);
                
                // 4. UPDATE STUDENT'S SCORE IN data.json
                student.previousScore = student.score;
                student.score = perfScore;
                student.speedIndex = result.lhr.audits['speed-index']?.displayValue || 'N/A';
                student.firstContentfulPaint = result.lhr.audits['first-contentful-paint']?.displayValue || 'N/A';
                student.lastTested = new Date().toISOString();
                student.testedWith = ['Lighthouse'];
                
                console.log(\`âœ… \${student.name}: \${perfScore}/100\`);
                
              } catch (error) {
                console.log(\`âŒ Failed \${student.name}: \${error.message}\`);
                student.lastTested = new Date().toISOString();
                student.testError = error.message;
              }
              
              // Wait 2 seconds between tests
              await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            await browser.close();
            
            // 5. SAVE UPDATED data.json BACK TO REPO
            data.lastUpdated = new Date().toISOString();
            data.testedWith = 'Lighthouse';
            
            fs.writeFileSync('data.json', JSON.stringify(data, null, 2));
            console.log(\`ğŸ‰ Updated data.json with Lighthouse results!\`);
          }
          
          testAllSites().catch(console.error);
          EOF
          
          # RUN THE SCRIPT
          node lighthouse-test.js
          
      - name: ğŸ“ Commit updated data.json
        run: |
          git config user.name "Lighthouse Bot"
          git config user.email "lighthouse@github.com"
          git add data.json
          git commit -m "ğŸ¯ Lighthouse test results" || echo "No changes"
          git push
