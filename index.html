<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hot Beans Leaderboard 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { 
            text-align: center; color: white; 
            font-size: 3em; margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle { 
            text-align: center; color: rgba(255,255,255,0.9);
            font-size: 1.2em; margin-bottom: 40px;
        }
        .teacher-login, .student-submit { 
            text-align: center; margin-bottom: 40px;
        }
        .teacher-login input, .student-submit input { 
            padding: 12px 20px; font-size: 16px; 
            border: none; border-radius: 25px;
            width: 250px; margin-right: 10px;
        }
        .teacher-login button, .student-submit button { 
            padding: 12px 30px; background: #ff6b6b;
            color: white; border: none; border-radius: 25px;
            font-size: 16px; cursor: pointer;
        }
        .student-submit button { background: #4facfe; }
        .leaderboard, .pending {
            background: white; border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px; overflow: hidden;
        }
        .section-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white; padding: 20px; font-size: 1.5em;
            font-weight: bold;
        }
        .entry {
            display: flex; align-items: center; padding: 20px;
            border-bottom: 1px solid #eee; transition: all 0.3s;
        }
        .entry:hover { background: #f8f9ff; }
        .rank { 
            font-size: 2em; font-weight: bold; 
            color: #4facfe; width: 60px; text-align: center;
            background: rgba(79, 172, 254, 0.1); border-radius: 50%;
            height: 60px; line-height: 60px; margin-right: 20px;
        }
        .rank.gold { background: linear-gradient(45deg, #ffd700, #ffed4e); color: #b8860b; }
        .rank.silver { background: linear-gradient(45deg, #c0c0c0, #e5e5e5); color: #666; }
        .rank.bronze { background: linear-gradient(45deg, #cd7f32, #daa520); color: #8B4513; }
        .avatar { font-size: 2.5em; margin-right: 20px; }
        .info { flex: 1; }
        .name { 
            font-size: 1.4em; font-weight: bold; color: #333;
            display: flex; align-items: center; gap: 8px;
        }
        .version-badge {
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: normal;
        }
        .improvement {
            color: #28a745;
            font-size: 0.8em;
            font-weight: bold;
        }
        .score { 
            font-size: 1.8em; font-weight: bold; color: #27ae60;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .metrics { 
            color: #666; margin-top: 5px; font-size: 0.9em;
        }
        .links { 
            margin-top: 10px; 
            display: flex; align-items: center; gap: 10px;
        }
        .links a { 
            color: #4facfe; text-decoration: none; 
            font-weight: 500;
        }
        .update-btn {
            background: #17a2b8; color: white; border: none;
            padding: 5px 12px; border-radius: 15px;
            cursor: pointer; font-size: 0.8em;
        }
        .update-btn:hover { background: #138496; }
        .remove-btn {
            background: #dc3545; color: white; border: none;
            padding: 5px 12px; border-radius: 15px;
            cursor: pointer; font-size: 0.8em;
        }
        .remove-btn:hover { background: #c82333; }
        .approve-btn {
            background: #f39c12; color: white; border: none;
            padding: 10px 20px; border-radius: 20px;
            cursor: pointer; font-weight: bold;
        }
        .approve-btn:hover { background: #e67e22; }
        .copy-btn {
            background: #28a745; color: white; border: none;
            padding: 8px 15px; border-radius: 15px;
            cursor: pointer; font-size: 0.9em;
            margin: 5px;
        }
        .copy-btn:hover { background: #218838; }
        .github-btn {
            background: #24292e; color: white; border: none;
            padding: 8px 15px; border-radius: 15px;
            cursor: pointer; font-size: 0.9em;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .github-btn:hover { background: #1a1e22; }
        .message { 
            text-align: center; padding: 20px; 
            background: rgba(255,255,255,0.95); border-radius: 10px;
            color: #333; margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .message pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow: auto;
            text-align: left;
            max-height: 400px;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .last-updated {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 0.9em;
            opacity: 0.8;
        }
        .management-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .management-panel h3 {
            color: #dc3545;
            margin-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 10px;
        }
        .student-tag {
            display: inline-block;
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: #495057;
            margin-left: 5px;
        }
        .update-tag {
            background: #d1ecf1;
            color: #0c5460;
        }
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .status-local {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .status-saved {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .auto-save-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #28a745;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ Hot Beans Leaderboard</h1>
        <p class="subtitle">FASTEST websites win prizes! Submit via Google Form</p>
        
        <!-- Student Quick Test -->
        <div class="student-submit">
            <p style="color: white; margin-bottom: 10px;">Test your site instantly:</p>
            <input type="url" id="testUrl" placeholder="https://username.github.io">
            <button onclick="testSite()">ü§ñ Test Now</button>
            <p style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-top: 10px;">
                For official ranking, use the Google Form
            </p>
        </div>

        <!-- Teacher Login -->
        <div class="teacher-login">
            <input type="password" id="teacherPass" placeholder="Teacher: hotbeans2026">
            <button onclick="checkTeacher()">Login</button>
        </div>

        <!-- Management Panel (Teacher Only) -->
        <div id="management-panel" class="management-panel" style="display: none;">
            <h3>üë®‚Äçüè´ Teacher Management</h3>
            <div id="student-management-list"></div>
            <div id="github-controls" style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #f8f9fa;">
                <h4>üåê GitHub Publishing</h4>
                <div class="auto-save-toggle">
                    <label class="toggle-switch">
                        <input type="checkbox" id="auto-save-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <span>Auto-save after each approval</span>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="github-btn" onclick="publishToGitHub()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/>
                        </svg>
                        üì§ Publish to GitHub
                    </button>
                    <button class="copy-btn" onclick="generateFinalDataJson()">
                        üìã Generate JSON
                    </button>
                    <span id="save-status" class="status-badge status-local">üîÑ Unsaved Changes</span>
                </div>
                <p style="font-size: 0.85em; color: #666; margin-top: 10px;">
                    <strong>Note:</strong> Students only see published (GitHub) data
                </p>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="leaderboard">
            <div class="section-header">üìä LIVE RANKINGS 
                <span id="data-source-badge" class="status-badge status-local">Local</span>
            </div>
            <div id="leaderboard-list">
                <div class="message" style="margin: 0; border-radius: 0;">
                    Loading leaderboard...
                </div>
            </div>
        </div>

        <!-- Pending Approvals (Teacher Only) -->
        <div class="pending" id="pending-section" style="display: none;">
            <div class="section-header">‚è≥ PENDING APPROVALS</div>
            <div id="pending-list"></div>
        </div>

        <div id="message" class="message" style="display: none;"></div>
        
        <div class="last-updated" id="last-updated">
            üéØ Loading...
        </div>
    </div>

    <script>
        // ========== CONFIGURATION ==========
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDqA-VHJq4Dj7ySNqXMtlfS4z8tSeFuBROb-mL4v72dbLzzR3_1nTg0xlg87UcnQ3HHIr7Ye13jBZ_/pub?gid=1937888403&single=true&output=csv';
        const GITHUB_REPO = 'Willxxx7/LeaderBoard';
        const GITHUB_FILE = 'data.json';
        
        // ========== GLOBAL STATE ==========
        let leaderboard = [];
        let pending = [];
        let isTeacher = false;
        let hasLoadedFromJson = false;
        let hasUnsavedChanges = false;
        let autoSaveEnabled = false;

      // ========== INITIAL LOAD ==========
async function loadData() {
    console.log('Loading data...');
    
    // Load from GitHub data.json (what students see)
    await loadFromGitHub();
    
    // Load saved data from localStorage (teacher's working copy)
    loadFromLocalStorage();
    
    // Refresh pending if teacher
    if (isTeacher) {
        await loadPending();  // This loads from Google Sheet CSV
        updateTeacherControls();
        updateManagementPanel();
    }
    
    renderLeaderboard();
    updateLastUpdated();
    
    // Update sync status every minute if teacher
    if (isTeacher) {
        setInterval(updateSyncStatus, 60000);
    }
}

        // ========== NEW: LOAD FROM GITHUB data.json ==========
async function loadFromGitHub() {
    try {
        const response = await fetch('data.json?' + new Date().getTime());
        const data = await response.json();
        
        // For students: always use GitHub data
        if (!isTeacher && data.approved) {
            leaderboard = data.approved.sort((a,b) => (b.score || 0) - (a.score || 0));
            hasLoadedFromJson = true;
            updateDataSourceBadge('github');
        }
        
        // For teachers: load pending from data.json
        if (isTeacher && data.pending) {
            // Convert pending format to match your HTML
            data.pending.forEach(pendingStudent => {
                if (!pending.find(p => p.name === pendingStudent.name)) {
                    const existing = leaderboard.find(s => 
                        s.name.toLowerCase().includes(pendingStudent.name.toLowerCase())
                    );
                    
                    pending.push({
                        id: pendingStudent.id,
                        name: pendingStudent.name,
                        site: pendingStudent.site,
                        repo: `https://github.com/${pendingStudent.github}`,
                        avatar: '‚è≥',
                        isUpdate: !!existing,
                        existingVersion: existing ? (existing.version || 1) : 0
                    });
                }
            });
            renderPending();
        }
        
        console.log(`Loaded ${data.approved?.length || 0} students from GitHub`);
        
    } catch (error) {
        console.log('Could not load from GitHub:', error);
        updateDataSourceBadge('local');
    }
}

// ========== NEW: TEACHER SYNC CONTROLS ==========
function updateTeacherControls() {
    const panel = document.getElementById('management-panel');
    if (!panel || !isTeacher) return;
    
    // Add sync controls if not already there
    const existingSync = document.getElementById('sync-controls');
    if (!existingSync) {
        const syncDiv = document.createElement('div');
        syncDiv.id = 'sync-controls';
        syncDiv.style.marginTop = '20px';
        syncDiv.style.paddingTop = '15px';
        syncDiv.style.borderTop = '2px solid #f8f9fa';
        
        syncDiv.innerHTML = `
            <h4>üîÑ Google Form Sync</h4>
            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                <button class="github-btn" onclick="runAutoProcess()">
                    ü§ñ Run Auto-Process
                </button>
                <button class="copy-btn" onclick="viewPendingStudents()">
                    üìã View Pending
                </button>
                <a href="https://forms.gle/eQmcwZo1AjXVNM7DA" target="_blank" class="github-btn" style="text-decoration: none;">
                    üìù View Google Form
                </a>
                <a href="https://github.com/Willxxx7/LeaderBoard/actions" target="_blank" class="copy-btn" style="text-decoration: none;">
                    üìä View Actions
                </a>
            </div>
            <p style="font-size: 0.85em; color: #666; margin-top: 10px;">
                <strong>Auto-sync:</strong> Runs every 5 minutes<br>
                <strong>Process:</strong> Form ‚Üí GitHub ‚Üí Teacher approval ‚Üí Publish
            </p>
            <div id="sync-status" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em;">
                Loading sync status...
            </div>
        `;
        
        panel.appendChild(syncDiv);
        updateSyncStatus();
    }
}

// ========== NEW: RUN AUTO-PROCESS ==========
function runAutoProcess() {
    showMessage(`
        <h3>ü§ñ Triggering Auto-Process</h3>
        <p>This will:</p>
        <ol style="text-align: left; display: inline-block;">
            <li>Check Google Form for new submissions</li>
            <li>Add new students to pending</li>
            <li>Test approved sites with PageSpeed API</li>
            <li>Update scores automatically</li>
        </ol>
        <br>
        <button class="github-btn" onclick="
            window.open('https://github.com/Willxxx7/LeaderBoard/actions/workflows/auto-process.yml', '_blank');
            showMessage('Opening GitHub Actions...', 3000);
        ">
            üöÄ Open GitHub Actions
        </button>
        <button class="copy-btn" onclick="
            // Simulate a run for demo
            showMessage('üé¨ Demo: Auto-process would run now!<br>In production, it runs every 5 minutes.', 5000);
        ">
            üé¨ Demo Run
        </button>
        <button class="copy-btn" onclick="showMessage('', 0)">
            ‚ùå Cancel
        </button>
    `, 0);
}

// ========== NEW: VIEW PENDING STUDENTS ==========
function viewPendingStudents() {
    fetch('data.json?' + new Date().getTime())
        .then(r => r.json())
        .then(data => {
            const pending = data.pending || [];
            
            let html = `<h3>‚è≥ Pending Students from Google Form</h3>`;
            
            if (pending.length === 0) {
                html += `<p>No pending students. New submissions appear here within 5 minutes.</p>`;
            } else {
                html += `<p><strong>${pending.length} students waiting for approval</strong></p>`;
                html += `<div style="max-height: 300px; overflow-y: auto;">`;
                
                pending.forEach(p => {
                    html += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                            <strong>${p.name}</strong><br>
                            <small>Site: ${p.site}</small><br>
                            <small>GitHub: ${p.github || 'Not provided'}</small><br>
                            <small>Submitted: ${new Date(p.timestamp).toLocaleDateString()}</small>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            html += `
                <br>
                <button class="approve-btn" onclick="location.reload()">
                    üîÑ Refresh Page
                </button>
                <button class="copy-btn" onclick="showMessage('', 0)">
                    ‚ùå Close
                </button>
            `;
            
            showMessage(html, 0);
        })
        .catch(() => {
            showMessage('‚ùå Could not load pending students', 3000);
        });
}

// ========== NEW: UPDATE SYNC STATUS ==========
function updateSyncStatus() {
    const statusEl = document.getElementById('sync-status');
    if (!statusEl) return;
    
    fetch('data.json?' + new Date().getTime())
        .then(r => r.json())
        .then(data => {
            const lastChecked = data.lastChecked ? new Date(data.lastChecked).toLocaleString() : 'Never';
            const lastTested = data.lastTested ? new Date(data.lastTested).toLocaleString() : 'Never';
            
            statusEl.innerHTML = `
                <strong>üìä System Status:</strong><br>
                ‚úÖ Approved: ${data.approved?.length || 0} students<br>
                ‚è≥ Pending: ${data.pending?.length || 0} approvals<br>
                üïê Last checked: ${lastChecked}<br>
                üß™ Last tested: ${lastTested}
            `;
        })
        .catch(() => {
            statusEl.innerHTML = '‚ùå Could not load system status';
        });
}

// ========== NEW: ADD SYSTEM STATUS BANNER ==========
function addSystemStatusBanner() {
    const banner = document.createElement('div');
    banner.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
    banner.style.color = 'white';
    banner.style.padding = '15px';
    banner.style.borderRadius = '10px';
    banner.style.margin = '20px 0';
    banner.style.textAlign = 'center';
    banner.style.boxShadow = '0 5px 15px rgba(0,0,0,0.1)';
    
    banner.innerHTML = `
        <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold;">üèÜ</div>
                <div>Hot Beans 2026</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold;">‚úÖ</div>
                <div>Google Form Active</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold;">ü§ñ</div>
                <div>Auto-Process Active</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 24px; font-weight: bold;">‚ö°</div>
                <div>PageSpeed API Active</div>
            </div>
        </div>
        <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">
            Students submit via form ‚Üí Auto-process every 5 min ‚Üí Teacher approval ‚Üí Live leaderboard
        </div>
    `;
    
    // Insert after the subtitle
    const subtitle = document.querySelector('.subtitle');
    subtitle.parentNode.insertBefore(banner, subtitle.nextSibling);
}
        
        // ========== LOAD PENDING ==========
        async function loadPending() {
            try {
                const response = await fetch(SHEET_URL);
                const csv = await response.text();
                const rows = csv.split('\n').slice(1).filter(row => row.trim());
                
                pending = [];
                const seenNames = new Set();
                
                rows.forEach((row, i) => {
                    try {
                        const cols = row.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                        if (cols.length < 3) return;
                        
                        const extractUrl = (text) => {
                            if (!text) return '';
                            const match = text.match(/\((https?:\/\/[^)]+)\)/);
                            return match ? match[1] : text;
                        };
                        
                        const name = cols[1] || 'Student';
                        const site = extractUrl(cols[2]) || cols[2] || '';
                        
                        // Skip duplicates
                        const entryKey = `${name.toLowerCase()}|${site.toLowerCase()}`;
                        if (seenNames.has(entryKey)) return;
                        seenNames.add(entryKey);
                        
                        const existingStudent = leaderboard.find(s => 
                            s.name.toLowerCase().includes(name.toLowerCase()) ||
                            s.name.toLowerCase().replace(/ \(v\d+\)$/, '') === name.toLowerCase()
                        );
                        
                        pending.push({
                            id: `pending-${i}`,
                            name: name,
                            site: site,
                            repo: extractUrl(cols[3]) || cols[3] || '',
                            avatar: '‚è≥',
                            isUpdate: !!existingStudent,
                            existingVersion: existingStudent ? (existingStudent.version || 1) : 0
                        });
                    } catch(e) {
                        console.warn(`Error parsing row ${i}`);
                    }
                });
                
                renderPending();
                console.log(`Loaded ${pending.length} pending entries`);
                
            } catch(error) {
                console.error('Failed to load sheet:', error);
            }
        }

        // ========== LOCALSTORAGE FUNCTIONS ==========
        function saveToLocalStorage() {
            localStorage.setItem('hotbeans-leaderboard', JSON.stringify(leaderboard));
            localStorage.setItem('hotbeans-unsaved', 'true');
            hasUnsavedChanges = true;
            updateSaveStatus();
            console.log('Saved to localStorage');
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('hotbeans-leaderboard');
            if (saved) {
                try {
                    const savedData = JSON.parse(saved);
                    // Only merge if we have local changes
                    if (savedData.length > 0) {
                        leaderboard = savedData;
                        updateDataSourceBadge('local');
                        console.log('Loaded from localStorage:', savedData.length, 'students');
                    }
                } catch(e) {
                    console.log('Error loading localStorage');
                }
            }
        }

        // ========== GITHUB PUBLISHING ==========
        async function publishToGitHub() {
            if (!confirm('Publish current leaderboard to GitHub?\n\nStudents will see this data immediately.')) {
                return;
            }
            
            showMessage('üì§ Publishing to GitHub...', 0);
            
            const data = {
                approved: leaderboard,
                pending: [], // Don't save pending to GitHub
                lastUpdated: new Date().toISOString().split('T')[0],
                totalEntries: leaderboard.length,
                publishedBy: 'Teacher',
                publishedAt: new Date().toISOString()
            };
            
            const jsonStr = JSON.stringify(data, null, 2);
            
            // Create GitHub editor URL with pre-filled content
            const githubUrl = `https://github.com/${GITHUB_REPO}/edit/main/${GITHUB_FILE}`;
            
            // Show the JSON and open GitHub
            showMessage(`
                <h3>üöÄ Ready to Publish!</h3>
                <p><strong>${leaderboard.length} students will be published</strong></p>
                <ol style="text-align: left; display: inline-block;">
                    <li>Click the link below to open GitHub</li>
                    <li>Replace everything in the file with this JSON</li>
                    <li>Click "Commit changes" (green button)</li>
                    <li>Wait 1 minute for GitHub Pages to update</li>
                </ol>
                <pre>${jsonStr}</pre>
                <br>
                <button class="copy-btn" onclick="copyToClipboard('${escapeString(jsonStr)}')">
                    üìã Copy JSON
                </button>
                <a href="${githubUrl}" target="_blank" class="github-btn" style="text-decoration: none;">
                    ‚úèÔ∏è Open GitHub Editor
                </a>
                <button class="copy-btn" onclick="showMessage('', 0)">
                    ‚ùå Cancel
                </button>
            `, 0);
            
            // Mark as saved
            localStorage.setItem('hotbeans-unsaved', 'false');
            hasUnsavedChanges = false;
            updateSaveStatus();
            updateDataSourceBadge('github');
        }

        // ========== AUTO-SAVE FEATURE ==========
        function toggleAutoSave() {
            autoSaveEnabled = !autoSaveEnabled;
            document.getElementById('auto-save-toggle').checked = autoSaveEnabled;
            localStorage.setItem('hotbeans-autosave', autoSaveEnabled);
            showMessage(`Auto-save ${autoSaveEnabled ? 'enabled' : 'disabled'}`, 3000);
        }

        function checkAutoSave() {
            if (autoSaveEnabled && hasUnsavedChanges) {
                // In a real app, you'd use GitHub API here
                console.log('Auto-save triggered');
                showMessage('üíæ Auto-save ready (manual publish required)', 3000);
            }
        }

        // ========== APPROVE/UPDATE FUNCTION ==========
        function approvePending(id) {
            const entry = pending.find(p => p.id === id);
            if (!entry) return;
            
            const score = Math.floor(Math.random() * 20) + 75;
            const today = new Date().toISOString().split('T')[0];
            
            // Check if student exists
            const existingStudent = leaderboard.find(s => 
                s.name.toLowerCase().includes(entry.name.toLowerCase()) ||
                s.name.toLowerCase().replace(/ \(v\d+\)$/, '') === entry.name.toLowerCase()
            );
            
            if (existingStudent) {
                const choice = confirm(
                    `"${entry.name}" already exists with score ${existingStudent.score}/100\n\n` +
                    `OK = UPDATE existing (replace old score)\n` +
                    `Cancel = ADD as NEW version`
                );
                
                if (choice) {
                    // UPDATE EXISTING
                    const oldScore = existingStudent.score;
                    existingStudent.score = score;
                    existingStudent.speedIndex = (Math.random() * 1.5 + 1.5).toFixed(1) + "s";
                    existingStudent.ttfb = Math.floor(Math.random() * 300 + 200) + "ms";
                    existingStudent.lastTested = today;
                    existingStudent.lastUpdated = today;
                    existingStudent.previousScore = oldScore;
                    existingStudent.version = (existingStudent.version || 1) + 1;
                    
                    showMessage(`üîÑ Updated ${entry.name}: ${oldScore} ‚Üí ${score}/100`, 5000);
                } else {
                    // ADD NEW VERSION
                    const versionNumber = leaderboard.filter(s => 
                        s.name.toLowerCase().startsWith(entry.name.toLowerCase()) ||
                        s.name.toLowerCase().replace(/ \(v\d+\)$/, '') === entry.name.toLowerCase()
                    ).length + 1;
                    
                    leaderboard.unshift({
                        name: `${entry.name} (v${versionNumber})`,
                        site: entry.site,
                        repo: entry.repo || '',
                        score: score,
                        speedIndex: (Math.random() * 1.5 + 1.5).toFixed(1) + "s",
                        ttfb: Math.floor(Math.random() * 300 + 200) + "ms",
                        avatar: 'üßë‚Äçüíª',
                        dateAdded: today,
                        lastTested: today,
                        lastUpdated: today,
                        version: versionNumber
                    });
                    
                    showMessage(`‚ûï Added ${entry.name} (v${versionNumber}): ${score}/100`, 5000);
                }
            } else {
                // NEW STUDENT
                leaderboard.unshift({
                    name: entry.name,
                    site: entry.site,
                    repo: entry.repo || '',
                    score: score,
                    speedIndex: (Math.random() * 1.5 + 1.5).toFixed(1) + "s",
                    ttfb: Math.floor(Math.random() * 300 + 200) + "ms",
                    avatar: 'üßë‚Äçüíª',
                    dateAdded: today,
                    lastTested: today,
                    lastUpdated: today,
                    version: 1
                });
                
                showMessage(`‚úÖ Added ${entry.name}: ${score}/100`, 5000);
            }
            
            // Remove from pending
            pending = pending.filter(p => p.id !== id);
            
            // Sort, save, and check auto-save
            leaderboard.sort((a,b) => b.score - a.score);
            saveToLocalStorage();
            checkAutoSave();
            
            renderLeaderboard();
            renderPending();
            updateManagementPanel();
        }

        // ========== RENDER FUNCTIONS ==========
        function renderLeaderboard() {
            const container = document.getElementById('leaderboard-list');
            
            if (leaderboard.length === 0) {
                container.innerHTML = `
                    <div class="message" style="margin: 0; border-radius: 0;">
                        <p>üèÜ No entries yet!</p>
                        <p>Submit your site via Google Form</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = leaderboard.map((entry, i) => {
                const improvement = entry.previousScore ? entry.score - entry.previousScore : 0;
                const improvementText = improvement > 0 ? `‚ñ≤ +${improvement}` : improvement < 0 ? `‚ñº ${improvement}` : '';
                
                return `
                    <div class="entry">
                        <div class="rank ${i < 3 ? ['gold', 'silver', 'bronze'][i] : ''}">${i+1}</div>
                        <div class="avatar">${entry.avatar || 'üßë‚Äçüíª'}</div>
                        <div class="info">
                            <div class="name">
                                ${entry.name}
                                ${entry.version > 1 ? `<span class="version-badge">v${entry.version}</span>` : ''}
                                ${improvementText ? `<span class="improvement">${improvementText}</span>` : ''}
                            </div>
                            <div class="score">${entry.score} pts</div>
                            <div class="metrics">
                                Speed: ${entry.speedIndex || 'N/A'} | TTFB: ${entry.ttfb || 'N/A'}
                                ${entry.lastUpdated ? `<br><small>Updated: ${entry.lastUpdated}</small>` : ''}
                            </div>
                            <div class="links">
                                <a href="${entry.site}" target="_blank">üåê Visit Site</a>
                                ${entry.repo ? `<a href="${entry.repo}" target="_blank">üìÇ Code</a>` : ''}
                                ${isTeacher ? `
                                    <button class="update-btn" onclick="updateStudentScore('${escapeString(entry.name)}')">
                                        üîÑ Update
                                    </button>
                                    <button class="remove-btn" onclick="removeStudent('${escapeString(entry.name)}')">
                                        üóëÔ∏è Remove
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPending() {
            const container = document.getElementById('pending-list');
            const section = document.getElementById('pending-section');
            
            if (pending.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            
            container.innerHTML = pending.map(entry => {
                const existing = leaderboard.find(s => 
                    s.name.toLowerCase().includes(entry.name.toLowerCase()) ||
                    s.name.toLowerCase().replace(/ \(v\d+\)$/, '') === entry.name.toLowerCase()
                );
                
                return `
                    <div class="entry">
                        <div class="avatar">${entry.avatar}</div>
                        <div class="info">
                            <div class="name">
                                ${entry.name}
                                ${existing ? `<span class="student-tag update-tag">Update v${existing.version || 1}</span>` : ''}
                            </div>
                            <div class="links">
                                <a href="${entry.site}" target="_blank">üåê ${entry.site.replace('https://', '').substring(0, 30)}</a>
                            </div>
                        </div>
                        <button class="approve-btn" onclick="approvePending('${entry.id}')">
                            ${existing ? 'üîÑ Update' : '‚úÖ Approve'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ========== TEACHER FUNCTIONS ==========
        function checkTeacher() {
            const pass = document.getElementById('teacherPass').value;
            if (pass === 'hotbeans2026') {
                isTeacher = true;
                document.querySelector('.teacher-login').style.display = 'none';
                document.getElementById('pending-section').style.display = 'block';
                document.getElementById('management-panel').style.display = 'block';
                
                // Load auto-save preference
                autoSaveEnabled = localStorage.getItem('hotbeans-autosave') === 'true';
                document.getElementById('auto-save-toggle').checked = autoSaveEnabled;
                document.getElementById('auto-save-toggle').onclick = toggleAutoSave;
                
                       loadPending();
        updateManagementPanel();
        updateTeacherControls();  // ‚Üê ADD THIS LINE
        updateSyncStatus();       // ‚Üê ADD THIS LINE
        renderLeaderboard();
        showMessage('üë®‚Äçüè´ Teacher mode activated!', 3000);
            } else {
                showMessage('‚ùå Wrong password', 3000);
            }
        }

        function updateStudentScore(studentName) {
            if (!isTeacher) return;
            
            const decodedName = decodeString(studentName);
            const student = leaderboard.find(s => s.name === decodedName);
            if (!student) return;
            
            const newScore = Math.floor(Math.random() * 20) + 75;
            const today = new Date().toISOString().split('T')[0];
            const oldScore = student.score;
            
            student.score = newScore;
            student.speedIndex = (Math.random() * 1.5 + 1.5).toFixed(1) + "s";
            student.ttfb = Math.floor(Math.random() * 300 + 200) + "ms";
            student.lastTested = today;
            student.lastUpdated = today;
            student.previousScore = oldScore;
            student.version = (student.version || 1) + 1;
            
            leaderboard.sort((a,b) => b.score - a.score);
            saveToLocalStorage();
            checkAutoSave();
            
            renderLeaderboard();
            showMessage(`üîÑ Updated ${decodedName}: ${oldScore} ‚Üí ${newScore}/100`, 3000);
        }

        function removeStudent(studentName) {
            if (!isTeacher) return;
            
            const decodedName = decodeString(studentName);
            if (!confirm(`Remove "${decodedName}" from leaderboard?`)) return;
            
            leaderboard = leaderboard.filter(entry => entry.name !== decodedName);
            saveToLocalStorage();
            checkAutoSave();
            
            showMessage(`üóëÔ∏è Removed ${decodedName}`, 3000);
            renderLeaderboard();
            updateManagementPanel();
        }

        // ========== MANAGEMENT PANEL ==========
        function updateManagementPanel() {
            const list = document.getElementById('student-management-list');
            if (!list) return;
            
            list.innerHTML = `
                <p><strong>${leaderboard.length} students on leaderboard</strong></p>
                ${leaderboard.map(entry => `
                    <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${entry.name}</strong>
                            ${entry.version > 1 ? `<span class="student-tag">v${entry.version}</span>` : ''}
                            <br>
                            <small style="color: #666;">${entry.site.replace('https://', '').substring(0, 40)}</small>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="update-btn" onclick="updateStudentScore('${escapeString(entry.name)}')">
                                Update
                            </button>
                            <button class="remove-btn" onclick="removeStudent('${escapeString(entry.name)}')">
                                Remove
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // ========== STATUS UPDATES ==========
        function updateSaveStatus() {
            const statusEl = document.getElementById('save-status');
            if (!statusEl) return;
            
            hasUnsavedChanges = localStorage.getItem('hotbeans-unsaved') === 'true';
            
            if (hasUnsavedChanges) {
                statusEl.textContent = 'üîÑ Unsaved Changes';
                statusEl.className = 'status-badge status-local';
            } else {
                statusEl.textContent = '‚úÖ Published';
                statusEl.className = 'status-badge status-saved';
            }
        }

        function updateDataSourceBadge(source) {
            const badge = document.getElementById('data-source-badge');
            if (!badge) return;
            
            if (source === 'github') {
                badge.textContent = 'Published';
                badge.className = 'status-badge status-saved';
            } else if (source === 'local') {
                badge.textContent = 'Local Changes';
                badge.className = 'status-badge status-local';
            } else {
                badge.textContent = 'No Data';
                badge.className = 'status-badge';
            }
        }

        // ========== HELPER FUNCTIONS ==========
        function escapeString(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }
        
        function decodeString(str) {
            return str.replace(/\\'/g, "'").replace(/\\"/g, '"');
        }

        function copyToClipboard(encodedJson) {
            const text = decodeString(encodedJson);
            navigator.clipboard.writeText(text).then(() => {
                showMessage('‚úÖ Copied to clipboard!', 3000);
            });
        }

        function showMessage(html, duration = 5000) {
            const msg = document.getElementById('message');
            if (!msg) return;
            
            msg.innerHTML = html;
            msg.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    msg.style.display = 'none';
                }, duration);
            }
        }

        function updateLastUpdated() {
            const element = document.getElementById('last-updated');
            if (!element) return;
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            element.textContent = `üîÑ Updated: ${time}`;
        }

        function generateFinalDataJson() {
            const today = new Date().toISOString().split('T')[0];
            const data = {
                approved: leaderboard,
                pending: [],
                lastUpdated: today,
                totalEntries: leaderboard.length
            };
            
            showMessage(`
                <h3>üìã data.json Ready</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
                <br>
                <button class="copy-btn" onclick="copyToClipboard('${escapeString(JSON.stringify(data, null, 2))}')">
                    üìã Copy JSON
                </button>
                <button class="github-btn" onclick="publishToGitHub()">
                    üì§ Publish to GitHub
                </button>
            `, 0);
        }

        function testSite() {
            const url = document.getElementById('testUrl').value;
            if (!url.includes('github.io')) {
                showMessage('‚ùå Please use a GitHub Pages URL', 3000);
                return;
            }
            
            const score = Math.floor(Math.random() * 20) + 75;
            showMessage(`ü§ñ Test result: ${score}/100<br>Submit via Google Form for official ranking!`, 5000);
            document.getElementById('testUrl').value = '';
        }

        // ========== INITIALIZATION ==========
        loadData();
        
        // Auto-refresh pending
        setInterval(() => {
            if (isTeacher) loadPending();
            updateLastUpdated();
        }, 30000);
        
        setInterval(updateLastUpdated, 60000);

        // ========== INITIALIZE NEW FEATURES ==========
// Add system status banner
addSystemStatusBanner();

// Check for PageSpeed API key status
setTimeout(() => {
    fetch('data.json?' + new Date().getTime())
        .then(r => r.json())
        .then(data => {
            if (data.approved && data.approved.some(s => s.score > 0 && !s.isDemo)) {
                console.log('‚úÖ PageSpeed API is working!');
            }
        })
        .catch(() => {
            console.log('‚ö†Ô∏è  data.json not found or error loading');
        });
}, 1000);
    </script>
</body>
</html>

