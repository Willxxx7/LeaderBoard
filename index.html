<script>
  const TEACHER_PASSWORD = "hotbeans2026";
  const WPT_PUBLIC_URL = "https://www.webpagetest.org"; // Public WebPageTest
  let isLoggedIn = localStorage.getItem('teacher-logged-in') === 'true';
  let leaderboard = JSON.parse(localStorage.getItem('leaderboard-approved')) || [];
  let pending = JSON.parse(localStorage.getItem('leaderboard-pending')) || [];

  // Initial render
  renderLeaderboard();
  if (isLoggedIn) {
    document.getElementById('teacherControls').innerHTML =
      '‚úÖ Teacher Active | <button onclick="logout()" style="background:none;border:none;color:white;cursor:pointer;">Logout</button>';
    document.getElementById('pendingSection').style.display = 'block';
    renderPending();
  }

  // Teacher button ‚Üí open login modal
  document.getElementById('teacherControls').onclick = function () {
    if (!isLoggedIn) {
      document.getElementById('loginPrompt').style.display = 'flex';
    }
  };

  function login() {
    const value = document.getElementById('teacher-password').value;
    if (value === TEACHER_PASSWORD) {
      isLoggedIn = true;
      localStorage.setItem('teacher-logged-in', 'true');
      document.getElementById('loginPrompt').style.display = 'none';
      document.getElementById('teacherControls').innerHTML =
        '‚úÖ Teacher Active | <button onclick="logout()" style="background:none;border:none;color:white;cursor:pointer;">Logout</button>';
      document.getElementById('pendingSection').style.display = 'block';
      document.getElementById('teacher-password').value = '';
      document.getElementById('login-status').textContent = '';
      renderPending();
    } else {
      document.getElementById('login-status').innerHTML = '‚ùå Wrong password!';
    }
  }

  function logout() {
    isLoggedIn = false;
    localStorage.removeItem('teacher-logged-in');
    document.getElementById('teacherControls').innerHTML = 'üë®‚Äçüè´ TEACHER LOGIN';
    document.getElementById('pendingSection').style.display = 'none';
  }

  function addPendingEntry() {
  const name = prompt('Student Name:');
  if (!name || name.trim() === '') {
    alert('‚ùå Name required!');
    return;
  }
  
  const site = prompt('Site URL (github.io):\nhttps://username.github.io/repo');
  if (!site || !site.includes('github.io')) {
    alert('‚ùå Must be github.io site!');
    return;
  }
  
  // ‚úÖ ONLY 2 FIELDS - Name + github.io site
  pending.unshift({
    name: name.trim(),
    site: site.trim(),
    repo: '#',  // Dummy repo link
    id: Date.now() + Math.random(),
    timestamp: new Date().toLocaleString()
  });
  
  localStorage.setItem('leaderboard-pending', JSON.stringify(pending));
  renderPending();
  alert(`‚úÖ "${name}" added! üöÄ Click WEBPAGETEST APPROVE`);
}

  // WebPageTest auto-scoring
  async function approve(id) {
    const entry = pending.find(e => e.id === id);
    if (!entry) return;

    const btn = document.querySelector(`button[onclick="approve(${entry.id})"]`);
    if (btn) {
      btn.innerHTML = '‚è≥ Testing...';
      btn.className = 'approval-btn approval-testing';
    }

    try {
      const testResult = await runWebPageTest(entry.site);
      leaderboard.unshift({
        ...entry,
        score: testResult.score,
        speedIndex: testResult.speedIndex,
        ttfb: testResult.ttfb
      });

      localStorage.setItem('leaderboard-approved', JSON.stringify(leaderboard));
      pending = pending.filter(e => e.id !== id);
      localStorage.setItem('leaderboard-pending', JSON.stringify(pending));

      renderPending();
      renderLeaderboard();
    } catch (e) {
      alert('Test failed! Using fallback score: ' + e.message);
      const score = 85;
      leaderboard.unshift({ ...entry, score, speedIndex: 'Manual', ttfb: 'N/A' });
      pending = pending.filter(e => e.id !== id);
      localStorage.setItem('leaderboard-approved', JSON.stringify(leaderboard));
      localStorage.setItem('leaderboard-pending', JSON.stringify(pending));
      renderPending();
      renderLeaderboard();
    }
  }

  // Call WebPageTest public API
  async function runWebPageTest(url) {
    document.getElementById('testProgress').style.display = 'flex';
    document.getElementById('testUrl').textContent = url.replace('https://', '');

    const testParams = new URLSearchParams({
      url: url,
      f: 'json',
      l: 'London:Chrome'
    });

    // submit test
    const submitResponse = await fetch(`${WPT_PUBLIC_URL}/runtest.php?${testParams}`);
    const submitData = await submitResponse.json();

    if (!submitData.data || !submitData.data.testId) {
      document.getElementById('testProgress').style.display = 'none';
      throw new Error('Failed to submit test');
    }

    const testId = submitData.data.testId;
    document.getElementById('testStatus').innerHTML =
      `Test ID: ${testId} - Waiting for results...`;

    // poll results
    let result;
    for (let i = 0; i < 60; i++) {
      await new Promise(r => setTimeout(r, 5000));

      const resultResponse = await fetch(`${WPT_PUBLIC_URL}/result/${testId}/?f=json`);
      result = await resultResponse.json();

      if (result.data && result.data.median && result.data.median.SpeedIndex) break;

      document.getElementById('testStatus').innerHTML =
        `Test ID: ${testId} - ${(i + 1) * 5}s elapsed...`;
    }

    document.getElementById('testProgress').style.display = 'none';

    if (!result.data || !result.data.median || !result.data.median.SpeedIndex) {
      throw new Error('Test incomplete - using fallback');
    }

    const speedIndex = result.data.median.SpeedIndex;
    const score = Math.max(50, Math.min(100, 100 - speedIndex / 80));

    return {
      score: Math.round(score),
      speedIndex: `${(speedIndex / 1000).toFixed(1)}s`,
      ttfb: result.data.median.TTFB
        ? `${(result.data.median.TTFB / 1000).toFixed(0)}ms`
        : 'N/A'
    };
  }

  function reject(id) {
    pending = pending.filter(e => e.id !== id);
    localStorage.setItem('leaderboard-pending', JSON.stringify(pending));
    renderPending();
  }

  function renderPending() {
    const html = pending.map(entry => `
      <div style="border:1px solid #ddd;padding:1.5rem;margin:1rem 0;border-radius:10px;background:#f8f9fa;">
        <strong>${entry.name}</strong> | ${entry.timestamp}<br>
        üåê <a href="${entry.site}" target="_blank">${entry.site.replace('https://','')}</a><br>
        <button class="approval-btn approval-yes" onclick="approve(${entry.id})">üöÄ WEBPAGETEST APPROVE</button>
        <button class="approval-btn approval-no" onclick="reject(${entry.id})">‚ùå REJECT</button>
      </div>
    `).join('') || '<p>No pending submissions</p>';

    document.getElementById('pendingList').innerHTML = html;
  }

  function renderLeaderboard() {
    leaderboard.sort((a, b) => b.score - a.score);
    const tbody = document.getElementById('leaderboard');
    const html = leaderboard.map((entry, i) => `
      <tr class="${i < 3 ? 'rank-' + (i + 1) : ''}">
        <td><strong>${i + 1}üèÖ</strong></td>
        <td><strong>${entry.name}</strong></td>
        <td><a href="${entry.site}" target="_blank">${entry.site.replace('https://','')}</a></td>
        <td><a href="#" class="repo-link">üìÇ</a></td>
        <td>${entry.speedIndex || 'N/A'}</td>
        <td><span class="score-badge ${entry.score >= 90 ? 'score-90plus' : ''}">${entry.score ?? '-'}</span></td>
        ${isLoggedIn
          ? `<td><button onclick="remove(${entry.id})" style="background:#dc3545;color:white;border:none;padding:0.3rem 0.8rem;border-radius:10px;cursor:pointer;">üóëÔ∏è</button></td>`
          : ''}
      </tr>
    `).join('') || '<tr><td colspan="7" style="text-align:center;padding:2rem;color:#666;">No entries yet - submit via email to teacher!</td></tr>';

    tbody.innerHTML = html;
  }

  function remove(id) {
    leaderboard = leaderboard.filter(e => e.id !== id);
    localStorage.setItem('leaderboard-approved', JSON.stringify(leaderboard));
    renderLeaderboard();
  }
</script>

