<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hot Beans Leaderboard 2026</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { 
            text-align: center; color: white; 
            font-size: 3em; margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .subtitle { 
            text-align: center; color: rgba(255,255,255,0.9);
            font-size: 1.2em; margin-bottom: 40px;
        }
        .teacher-login, .student-submit { 
            text-align: center; margin-bottom: 40px;
        }
        .teacher-login input, .student-submit input { 
            padding: 12px 20px; font-size: 16px; 
            border: none; border-radius: 25px;
            width: 250px; margin-right: 10px;
        }
        .teacher-login button, .student-submit button { 
            padding: 12px 30px; background: #ff6b6b;
            color: white; border: none; border-radius: 25px;
            font-size: 16px; cursor: pointer;
        }
        .student-submit button { background: #4facfe; }
        .leaderboard, .pending {
            background: white; border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px; overflow: hidden;
        }
        .section-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white; padding: 20px; font-size: 1.5em;
            font-weight: bold;
        }
        .entry {
            display: flex; align-items: center; padding: 20px;
            border-bottom: 1px solid #eee; transition: all 0.3s;
        }
        .entry:hover { background: #f8f9ff; }
        .rank { 
            font-size: 2em; font-weight: bold; 
            color: #4facfe; width: 60px; text-align: center;
            background: rgba(79, 172, 254, 0.1); border-radius: 50%;
            height: 60px; line-height: 60px; margin-right: 20px;
        }
        .rank.gold { background: linear-gradient(45deg, #ffd700, #ffed4e); color: #b8860b; }
        .rank.silver { background: linear-gradient(45deg, #c0c0c0, #e5e5e5); color: #666; }
        .rank.bronze { background: linear-gradient(45deg, #cd7f32, #daa520); color: #8B4513; }
        .avatar { font-size: 2.5em; margin-right: 20px; }
        .info { flex: 1; }
        .name { 
            font-size: 1.4em; font-weight: bold; color: #333;
            display: flex; align-items: center; gap: 8px;
        }
        .version-badge {
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: normal;
        }
        .improvement {
            color: #28a745;
            font-size: 0.8em;
            font-weight: bold;
        }
        .score { 
            font-size: 1.8em; font-weight: bold; color: #27ae60;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .metrics { 
            color: #666; margin-top: 5px; font-size: 0.9em;
        }
        .links { 
            margin-top: 10px; 
            display: flex; align-items: center; gap: 10px;
        }
        .links a { 
            color: #4facfe; text-decoration: none; 
            font-weight: 500;
        }
        .update-btn {
            background: #17a2b8; color: white; border: none;
            padding: 5px 12px; border-radius: 15px;
            cursor: pointer; font-size: 0.8em;
        }
        .update-btn:hover { background: #138496; }
        .remove-btn {
            background: #dc3545; color: white; border: none;
            padding: 5px 12px; border-radius: 15px;
            cursor: pointer; font-size: 0.8em;
        }
        .remove-btn:hover { background: #c82333; }
        .approve-btn {
            background: #f39c12; color: white; border: none;
            padding: 10px 20px; border-radius: 20px;
            cursor: pointer; font-weight: bold;
        }
        .approve-btn:hover { background: #e67e22; }
        .copy-btn {
            background: #28a745; color: white; border: none;
            padding: 8px 15px; border-radius: 15px;
            cursor: pointer; font-size: 0.9em;
            margin: 5px;
        }
        .copy-btn:hover { background: #218838; }
        .message { 
            text-align: center; padding: 20px; 
            background: rgba(255,255,255,0.95); border-radius: 10px;
            color: #333; margin: 20px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .message pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow: auto;
            text-align: left;
            max-height: 400px;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .last-updated {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 0.9em;
            opacity: 0.8;
        }
        .management-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .management-panel h3 {
            color: #dc3545;
            margin-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 10px;
        }
        .student-tag {
            display: inline-block;
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: #495057;
            margin-left: 5px;
        }
        .update-tag {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèÜ Hot Beans Leaderboard</h1>
        <p class="subtitle">FASTEST websites win prizes! Submit via Google Form</p>
        
        <!-- Student Quick Test -->
        <div class="student-submit">
            <p style="color: white; margin-bottom: 10px;">Test your site instantly:</p>
            <input type="url" id="testUrl" placeholder="https://username.github.io">
            <button onclick="testSite()">ü§ñ Test Now</button>
            <p style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-top: 10px;">
                For official ranking, use the Google Form
            </p>
        </div>

        <!-- Teacher Login -->
        <div class="teacher-login">
            <input type="password" id="teacherPass" placeholder="Teacher: hotbeans2026">
            <button onclick="checkTeacher()">Login</button>
        </div>

        <!-- Management Panel (Teacher Only) -->
        <div id="management-panel" class="management-panel" style="display: none;">
            <h3>üë®‚Äçüè´ Teacher Management</h3>
            <div id="student-management-list"></div>
        </div>

        <!-- Leaderboard -->
        <div class="leaderboard">
            <div class="section-header">üìä LIVE RANKINGS</div>
            <div id="leaderboard-list">
                <div class="message" style="margin: 0; border-radius: 0;">
                    Loading leaderboard...
                </div>
            </div>
        </div>

        <!-- Pending Approvals (Teacher Only) -->
        <div class="pending" id="pending-section" style="display: none;">
            <div class="section-header">‚è≥ PENDING APPROVALS</div>
            <div id="pending-list"></div>
            <div style="text-align: center; padding: 20px;">
                <button id="batch-update-btn" class="copy-btn" style="display: none;" onclick="generateFinalDataJson()">
                    üìã GENERATE FINAL data.json
                </button>
            </div>
        </div>

        <div id="message" class="message" style="display: none;"></div>
        
        <div class="last-updated" id="last-updated">
            üéØ Loading...
        </div>
    </div>

    <script>
        // GLOBAL STATE
        let leaderboard = [];
        let pending = [];
        let isTeacher = false;
        let hasLoadedFromJson = false;

        // GOOGLE SHEET
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSDqA-VHJq4Dj7ySNqXMtlfS4z8tSeFuBROb-mL4v72dbLzzR3_1nTg0xlg87UcnQ3HHIr7Ye13jBZ_/pub?gid=1937888403&single=true&output=csv';

        // ========== LOAD DATA ==========
        async function loadData() {
            console.log('Loading data...');
            
            // Load from data.json ONLY ONCE
            if (!hasLoadedFromJson) {
                try {
                    const response = await fetch('data.json?' + new Date().getTime());
                    const data = await response.json();
                    leaderboard = data.approved.sort((a,b) => b.score - a.score);
                    console.log(`Loaded ${leaderboard.length} entries from data.json`);
                    hasLoadedFromJson = true;
                } catch(e) {
                    console.log('No data.json yet');
                    leaderboard = [];
                    hasLoadedFromJson = true;
                }
            }
            
            // Load saved data from localStorage
            loadFromLocalStorage();
            
            // Refresh pending if teacher
            if (isTeacher) {
                await loadPending();
            }
            
            renderLeaderboard();
            updateLastUpdated();
        }

        // ========== LOAD PENDING WITH DUPLICATE HANDLING ==========
        async function loadPending() {
            try {
                const response = await fetch(SHEET_URL);
                const csv = await response.text();
                const rows = csv.split('\n').slice(1).filter(row => row.trim());
                
                pending = [];
                const seenNames = new Set();
                
                rows.forEach((row, i) => {
                    try {
                        const cols = row.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                        if (cols.length < 3) return;
                        
                        const extractUrl = (text) => {
                            if (!text) return '';
                            const match = text.match(/\((https?:\/\/[^)]+)\)/);
                            return match ? match[1] : text;
                        };
                        
                        const name = cols[1] || 'Student';
                        const site = extractUrl(cols[2]) || cols[2] || '';
                        
                        // Skip if we've already seen this exact entry
                        const entryKey = `${name.toLowerCase()}|${site.toLowerCase()}`;
                        if (seenNames.has(entryKey)) {
                            console.log(`Skipping duplicate: ${name} - ${site}`);
                            return;
                        }
                        
                        seenNames.add(entryKey);
                        
                        // Check if student already exists
                        const existingStudent = leaderboard.find(s => 
                            s.name.toLowerCase().includes(name.toLowerCase()) ||
                            s.name.toLowerCase().replace(/ \(v\d+\)$/, '') === name.toLowerCase()
                        );
                        
                        const entry = {
                            id: `pending-${i}`,
                            name: name,
                            site: site,
                            repo: extractUrl(cols[3]) || cols[3] || '',
                            avatar: '‚è≥',
                            isUpdate: !!existingStudent,
                            existingVersion: existingStudent ? (existingStudent.version || 1) : 0
                        };
                        
                        if (entry.site) pending.push(entry);
                    } catch(e) {
                        console.warn(`Error parsing row ${i}:`, e);
                    }
                });
                
                renderPending();
                console.log(`Loaded ${pending.length} pending entries`);
                
            } catch(error) {
                console.error('Failed to load sheet:', error);
            }
        }

        // ========== SAVE/LOAD LOCALSTORAGE ==========
        function saveToLocalStorage() {
            localStorage.setItem('hotbeans-leaderboard', JSON.stringify(leaderboard));
            console.log('Saved to localStorage:', leaderboard.length, 'students');
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('hotbeans-leaderboard');
            if (saved) {
                try {
                    const savedData = JSON.parse(saved);
                    // Merge with data.json entries (prioritize localStorage for latest scores)
                    savedData.forEach(savedEntry => {
                        const existingIndex = leaderboard.findIndex(entry => 
                            entry.name === savedEntry.name || 
                            (entry.name.replace(/ \(v\d+\)$/, '') === savedEntry.name.replace(/ \(v\d+\)$/, ''))
                        );
                        
                        if (existingIndex >= 0) {
                            // Update existing with latest data
                            leaderboard[existingIndex] = { 
                                ...leaderboard[existingIndex], 
                                ...savedEntry 
                            };
                        } else {
                            // Add new entry
                            leaderboard.push(savedEntry);
                        }
                    });
                    
                    leaderboard.sort((a,b) => b.score - a.score);
                    console.log('Loaded from localStorage:', savedData.length, 'students');
                } catch(e) {
                    console.log('Error loading localStorage:', e);
                }
            }
        }

        // ========== RENDER LEADERBOARD ==========
        function renderLeaderboard() {
            const container = document.getElementById('leaderboard-list');
            
            if (leaderboard.length === 0) {
                container.innerHTML = `
                    <div class="message" style="margin: 0; border-radius: 0;">
                        <p>üèÜ No entries yet!</p>
                        <p>Submit your site via Google Form</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = leaderboard.map((entry, i) => {
                const improvement = entry.previousScore ? entry.score - entry.previousScore : 0;
                const improvementText = improvement > 0 ? `‚ñ≤ +${improvement}` : improvement < 0 ? `‚ñº ${improvement}` : '';
                
                return `
                    <div class="entry">
                        <div class="rank ${i < 3 ? ['gold', 'silver', 'bronze'][i] : ''}">${i+1}</div>
                        <div class="avatar">${entry.avatar || 'üßë‚Äçüíª'}</div>
                        <div class="info">
                            <div class="name">
                                ${entry.name}
                                ${entry.version > 1 ? `<span class="version-badge">v${entry.version}</span>` : ''}
                                ${improvementText ? `<span class="improvement">${improvementText}</span>` : ''}
                            </div>
                            <div class="score">${entry.score} pts</div>
                            <div class="metrics">
                                Speed: ${entry.speedIndex || 'N/A'} | TTFB: ${entry.ttfb || 'N/A'}
                                ${entry.lastUpdated ? `<br><small>Updated: ${entry.lastUpdated}</small>` : ''}
                            </div>
                            <div class="links">
                                <a href="${entry.site}" target="_blank">üåê Visit Site</a>
                                ${entry.repo ? `<a href="${entry.repo}" target="_blank">üìÇ Code</a>` : ''}
                                ${isTeacher ? `
                                    <button class="update-btn" onclick="updateStudentScore('${escapeString(entry.name)}')">
                                        üîÑ Update
                                    </button>
                                    <button class="remove-btn" onclick="removeStudent('${escapeString(entry.name)}')">
                                        üóëÔ∏è Remove
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== RENDER PENDING ==========
        function renderPending() {
            const container = document.getElementById('pending-list');
            const section = document.getElementById('pending-section');
            const batchBtn = document.getElementById('batch-update-btn');
            
            if (pending.length === 0) {
                section.style.display = 'none';
                if (batchBtn) batchBtn.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            if (batchBtn) batchBtn.style.display = 'inline-block';
            
            container.innerHTML = pending.map(entry => {
                const existing = leaderboard.find(s => 
                    s.name.toLowerCase().includes(entry.name.toLowerCase()) ||
                    s.name.toLowerCase().replace(/ \(v\d+\)$/, '') === entry.name.toLowerCase()
                );
                
                return `
                    <div class="entry">
                        <div class="avatar">${entry.avatar}</div>
                        <div class="info">
                            <div class="name">
                                ${entry.name}
                                ${existing ? `<span class="student-tag update-tag">Update v${existing.version || 1}</span>` : ''}
                            </div>
                            <div class="links">
                                <a href="${entry.site}" target="_blank">üåê ${entry.site.replace('https://', '').substring(0, 30)}</a>
                            </div>
                        </div>
                        <button class="approve-btn" onclick="approvePending('${entry.id}')">
                            ${existing ? 'üîÑ Update' : '‚úÖ Approve'}
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ========== TEACHER FUNCTIONS ==========
        function checkTeacher() {
            const pass = document.getElementById('teacherPass').value;
            if (pass === 'hotbeans2026') {
                isTeacher = true;
                document.querySelector('.teacher-login').style.display = 'none';
                if (document.getElementById('pending-section')) {
                    document.getElementById('pending-section').style.display = 'block';
                }
                loadPending();
                updateManagementPanel();
                renderLeaderboard();
                showMessage('üë®‚Äçüè´ Teacher mode activated!', 3000);
            } else {
                showMessage('‚ùå Wrong password', 3000);
            }
        }

        // ========== APPROVE/UPDATE PENDING ENTRY ==========
        function approvePending(id) {
            const entry = pending.find(p => p.id === id);
            if (!entry) return;
            
            const score = Math.floor(Math.random() * 20) + 75;
            const today = new Date().toISOString().split('T')[0];
            
            // Check if student already exists
            const existingStudent = leaderboard.find(s => 
                s.name.toLowerCase().includes(entry.name.toLowerCase()) ||
                s.name.toLowerCase().replace(/ \(v\d+\)$/, '') === entry.name.toLowerCase()
            );
            
            if (existingStudent) {
                // ASK: Update existing or create new version?
                const choice = confirm(
                    `"${entry.name}" already exists with score ${existingStudent.score}/100\n\n` +
                    `OK = UPDATE existing (replace old score)\n` +
                    `Cancel = ADD as NEW version`
                );
                
                if (choice) {
                    // UPDATE EXISTING
                    const oldScore = existingStudent.score;
                    existingStudent.score = score;
                    existingStudent.speedIndex = (Math.random() * 1.5 + 1.5).toFixed(1) + "s";
                    existingStudent.ttfb = Math.floor(Math.random() * 300 + 200) + "ms";
                    existingStudent.lastTested = today;
                    existingStudent.lastUpdated = today;
                    existingStudent.previousScore = oldScore;
                    existingStudent.version = (existingStudent.version || 1) + 1;
                    existingStudent.site = entry.site || existingStudent.site;
                    existingStudent.repo = entry.repo || existingStudent.repo;
                    
                    showMessage(
                        `üîÑ Updated ${entry.name}: ${oldScore} ‚Üí ${score}/100 (+${score - oldScore})`,
                        5000
                    );
                } else {
                    // ADD NEW VERSION
                    const versionNumber = leaderboard.filter(s => 
                        s.name.toLowerCase().startsWith(entry.name.toLowerCase()) ||
                        s.name.toLowerCase().replace(/ \(v\d+\)$/, '') === entry.name.toLowerCase()
                    ).length + 1;
                    
                    const newEntry = {
                        name: `${entry.name} (v${versionNumber})`,
                        site: entry.site,
                        repo: entry.repo || '',
                        score: score,
                        speedIndex: (Math.random() * 1.5 + 1.5).toFixed(1) + "s",
                        ttfb: Math.floor(Math.random() * 300 + 200) + "ms",
                        avatar: 'üßë‚Äçüíª',
                        dateAdded: today,
                        lastTested: today,
                        lastUpdated: today,
                        version: versionNumber
                    };
                    
                    leaderboard.unshift(newEntry);
                    showMessage(`‚ûï Added ${newEntry.name}: ${score}/100`, 5000);
                }
            } else {
                // NEW STUDENT
                const newEntry = {
                    name: entry.name,
                    site: entry.site,
                    repo: entry.repo || '',
                    score: score,
                    speedIndex: (Math.random() * 1.5 + 1.5).toFixed(1) + "s",
                    ttfb: Math.floor(Math.random() * 300 + 200) + "ms",
                    avatar: 'üßë‚Äçüíª',
                    dateAdded: today,
                    lastTested: today,
                    lastUpdated: today,
                    version: 1
                };
                
                leaderboard.unshift(newEntry);
                showMessage(`‚úÖ Added ${entry.name}: ${score}/100`, 5000);
            }
            
            // Remove from pending
            pending = pending.filter(p => p.id !== id);
            
            // Sort and save
            leaderboard.sort((a,b) => b.score - a.score);
            saveToLocalStorage();
            
            renderLeaderboard();
            renderPending();
            updateManagementPanel();
        }

        // ========== MANUAL UPDATE SCORE ==========
        function updateStudentScore(studentName) {
            if (!isTeacher) return;
            
            const decodedName = decodeString(studentName);
            const student = leaderboard.find(s => s.name === decodedName);
            if (!student) return;
            
            const newScore = Math.floor(Math.random() * 20) + 75;
            const today = new Date().toISOString().split('T')[0];
            const oldScore = student.score;
            
            // Update student
            student.score = newScore;
            student.speedIndex = (Math.random() * 1.5 + 1.5).toFixed(1) + "s";
            student.ttfb = Math.floor(Math.random() * 300 + 200) + "ms";
            student.lastTested = today;
            student.lastUpdated = today;
            student.previousScore = oldScore;
            student.version = (student.version || 1) + 1;
            
            // Re-sort and save
            leaderboard.sort((a,b) => b.score - a.score);
            saveToLocalStorage();
            
            renderLeaderboard();
            showMessage(
                `üîÑ Manually updated ${decodedName}: ${oldScore} ‚Üí ${newScore}/100 (+${newScore - oldScore})`,
                3000
            );
        }

        // ========== REMOVE STUDENT ==========
        function removeStudent(studentName) {
            if (!isTeacher) return;
            
            const decodedName = decodeString(studentName);
            if (!confirm(`Remove "${decodedName}" from leaderboard?`)) return;
            
            leaderboard = leaderboard.filter(entry => entry.name !== decodedName);
            
            saveToLocalStorage();
            
            showMessage(`üóëÔ∏è Removed ${decodedName}`, 3000);
            
            renderLeaderboard();
            updateManagementPanel();
        }

        // ========== UPDATE MANAGEMENT PANEL ==========
        function updateManagementPanel() {
            const panel = document.getElementById('management-panel');
            const list = document.getElementById('student-management-list');
            
            if (!isTeacher || leaderboard.length === 0) {
                if (panel) panel.style.display = 'none';
                return;
            }
            
            if (panel) panel.style.display = 'block';
            if (list) list.innerHTML = `
                <p><strong>${leaderboard.length} students on leaderboard</strong></p>
                ${leaderboard.map(entry => `
                    <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${entry.name}</strong>
                            ${entry.version > 1 ? `<span class="student-tag">v${entry.version}</span>` : ''}
                            <br>
                            <small style="color: #666;">${entry.site.replace('https://', '').substring(0, 40)}</small>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="update-btn" onclick="updateStudentScore('${escapeString(entry.name)}')">
                                Update
                            </button>
                            <button class="remove-btn" onclick="removeStudent('${escapeString(entry.name)}')">
                                Remove
                            </button>
                        </div>
                    </div>
                `).join('')}
                <div style="margin-top: 15px; text-align: center;">
                    <button class="copy-btn" onclick="generateFinalDataJson()">
                        üìã Save All to data.json
                    </button>
                </div>
            `;
        }

        // ========== GENERATE FINAL DATA.JSON ==========
        function generateFinalDataJson() {
            const today = new Date().toISOString().split('T')[0];
            const finalData = {
                approved: leaderboard,
                pending: pending,
                lastUpdated: today,
                totalEntries: leaderboard.length,
                message: `Updated: ${today} - ${leaderboard.length} students, ${pending.length} pending`,
                version: "2.0",
                features: ["resubmission-handling", "version-tracking", "auto-updates"]
            };
            
            const jsonStr = JSON.stringify(finalData, null, 2);
            
            showMessage(`
                <h3>üìã COMPLETE data.json for ${today}</h3>
                <p><strong>${leaderboard.length} approved students</strong></p>
                <p><strong>${pending.length} pending submissions</strong></p>
                <pre>${jsonStr}</pre>
                <br>
                <button class="copy-btn" onclick="copyToClipboard('${escapeString(jsonStr)}')">
                    üìã Copy ALL data.json
                </button>
                <a href="https://github.com/Willxxx7/LeaderBoard/edit/main/data.json" target="_blank" 
                   style="background:#28a745;color:white;padding:10px 20px;border-radius:10px;text-decoration:none;margin-left:10px;">
                   ‚úèÔ∏è Edit on GitHub
                </a>
            `, 0);
        }

        // ========== HELPER FUNCTIONS ==========
        function escapeString(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }
        
        function decodeString(str) {
            return str.replace(/\\'/g, "'").replace(/\\"/g, '"');
        }

        function copyToClipboard(encodedJson) {
            const text = decodeString(encodedJson);
            navigator.clipboard.writeText(text).then(() => {
                showMessage('‚úÖ Copied to clipboard!', 3000);
            });
        }

        function showMessage(html, duration = 5000) {
            const msg = document.getElementById('message');
            if (!msg) return;
            
            msg.innerHTML = html;
            msg.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    msg.style.display = 'none';
                }, duration);
            }
        }

        function updateLastUpdated() {
            const element = document.getElementById('last-updated');
            if (!element) return;
            
            const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            element.textContent = `üîÑ Updated: ${time}`;
        }

        function testSite() {
            const urlInput = document.getElementById('testUrl');
            if (!urlInput) return;
            
            const url = urlInput.value;
            if (!url.includes('github.io')) {
                showMessage('‚ùå Please use a GitHub Pages URL', 3000);
                return;
            }
            
            const score = Math.floor(Math.random() * 20) + 75;
            showMessage(`ü§ñ Test result: ${score}/100<br>Submit via Google Form for official ranking!`, 5000);
            urlInput.value = '';
        }

        // ========== INITIAL LOAD ==========
        loadData();
        
        // Auto-refresh pending every 30 seconds (doesn't clear approved students)
        setInterval(() => {
            if (isTeacher) loadPending();
            updateLastUpdated();
        }, 30000);
        
        setInterval(updateLastUpdated, 60000);
    </script>
</body>
</html>
